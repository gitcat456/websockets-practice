<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Chat - Learning Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #e5ddd5;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            width: 90%;
            max-width: 900px;
            height: 90vh;
            max-height: 800px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        h1 {
            background: #075e54;
            color: white;
            padding: 16px 20px;
            font-size: 18px;
            font-weight: 500;
        }
        
        .status {
            padding: 8px 20px;
            text-align: center;
            font-size: 13px;
            font-weight: normal;
        }
        
        .connected {
            background: #d4edda;
            color: #155724;
        }
        
        .disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #e5ddd5;
            background-image: 
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 10px,
                    rgba(0,0,0,0.02) 10px,
                    rgba(0,0,0,0.02) 20px
                );
        }
        
        .message {
            margin-bottom: 12px;
            padding: 8px 12px;
            padding-bottom: 20px;
            border-radius: 8px;
            max-width: 65%;
            position: relative;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            clear: both;
            display: inline-block;
        }
        
        .system-message {
            background: #fff4ce;
            color: #54656f;
            text-align: center;
            margin: 12px auto;
            max-width: 70%;
            font-size: 13px;
            padding: 8px 12px;
            border-radius: 8px;
            display: block;
            box-shadow: 0 1px 1px rgba(0,0,0,0.08);
        }
        
        .user-message {
            background: #d9fdd3;
            color: #111b21;
            float: right;
            clear: both;
            border-radius: 8px 8px 0 8px;
        }
        
        .other-message {
            background: white;
            color: #111b21;
            float: left;
            clear: both;
            border-radius: 8px 8px 8px 0;
        }
        
        .message-info {
            font-size: 12px;
            color: #667781;
            margin-bottom: 4px;
            font-weight: 500;
        }
        
        .user-message .message-info {
            color: #667781;
        }

        .message-timestamp {
            position: absolute;
            bottom: 4px;
            right: 10px;
            font-size: 11px;
            color: #667781;
        }
        
        .input-group {
            display: flex;
            gap: 8px;
            padding: 0 10px;
            margin-bottom: 8px;
        }
        
        input {
            padding: 12px 15px;
            border: 1px solid #d1d7db;
            border-radius: 8px;
            flex: 1;
            font-size: 15px;
            background: white;
        }
        
        input:focus {
            outline: none;
            border-color: #00a884;
        }
        
        button {
            padding: 12px 24px;
            background: #00a884;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
        }
        
        button:hover:not(:disabled) {
            background: #008f6c;
        }
        
        button:disabled {
            background: #b3b3b3;
            cursor: not-allowed;
        }
        
        .user-count {
            text-align: center;
            color: #54656f;
            padding: 8px;
            font-size: 13px;
            background: #f0f2f5;
        }
        
        .demo-info {
            background: #fff4ce;
            border-top: 1px solid #e9e9e9;
            padding: 15px 20px;
        }
        
        .demo-info h3 {
            color: #54656f;
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .demo-info ul {
            margin-left: 20px;
        }
        
        .demo-info li {
            margin-bottom: 6px;
            font-size: 13px;
            color: #54656f;
        }

        .chat-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-container::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .chat-container::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebSocket Chat Demo</h1>
        
        <div id="status" class="status disconnected">
            Disconnected
        </div>
        
        <div class="chat-container" id="chat">
            <div class="message system-message">
                Connecting to WebSocket server...
            </div>
        </div>
        
        <div class="input-group">
            <input type="text" id="usernameInput" placeholder="Enter your username" value="User">
        </div>
        
        <div class="input-group">
            <input type="text" id="messageInput" placeholder="Type your message..." disabled>
            <button id="sendButton" disabled>Send</button>
        </div>
        
        <div id="userCount" class="user-count">
            Users online: 0
        </div>
        
        <div class="demo-info">
            <h3>Learning Objectives:</h3>
            <ul>
                <li><strong>Real-time Communication:</strong> See messages appear instantly across all connected browsers</li>
                <li><strong>Connection Events:</strong> Watch connection/disconnection messages in real-time</li>
                <li><strong>User Count:</strong> See user count update automatically</li>
                <li><strong>Open multiple browser tabs</strong> to see the real-time effects!</li>
            </ul>
        </div>
    </div>

    <script>
        class WebSocketChat {
            constructor() {
                this.ws = null;
                this.isConnected = false;
                this.username = 'User';
                
                this.initializeElements();
                this.connect();
            }
            
            initializeElements() {
                this.statusEl = document.getElementById('status');
                this.chatEl = document.getElementById('chat');
                this.usernameInput = document.getElementById('usernameInput');
                this.messageInput = document.getElementById('messageInput');
                this.sendButton = document.getElementById('sendButton');
                this.userCountEl = document.getElementById('userCount');
                
                // Event listeners
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
                
                this.usernameInput.addEventListener('change', (e) => {
                    this.username = e.target.value || 'User';
                });
            }
            
            connect() {
                // Create WebSocket connection (auto-detects ws:// or wss://)
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}`;
                
                this.ws = new WebSocket(wsUrl);
                
                this.ws.onopen = () => {
                    console.log('WebSocket connected');
                    this.isConnected = true;
                    this.updateStatus('Connected', 'connected');
                    this.messageInput.disabled = false;
                    this.sendButton.disabled = false;
                };
                
                this.ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleMessage(data);
                };
                
                this.ws.onclose = () => {
                    console.log(' WebSocket disconnected');
                    this.isConnected = false;
                    this.updateStatus('Disconnected', 'disconnected');
                    this.messageInput.disabled = true;
                    this.sendButton.disabled = true;
                    
                    // Try to reconnect after 3 seconds
                    setTimeout(() => this.connect(), 3000);
                };
                
                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    this.updateStatus('Connection Error', 'disconnected');
                };
            }
            
            updateStatus(message, className) {
                this.statusEl.textContent = message;
                this.statusEl.className = `status ${className}`;
            }
            
            handleMessage(data) {
                console.log('Received:', data);
                
                switch(data.type) {
                    case 'system':
                        this.addSystemMessage(data.message);
                        if (data.userCount !== undefined) {
                            this.userCountEl.textContent = `Users online: ${data.userCount}`;
                        }
                        break;
                        
                    case 'chat':
                        this.addChatMessage(data.username, data.message, data.timestamp);
                        break;
                }
            }
            
            addSystemMessage(message) {
                const messageEl = document.createElement('div');
                messageEl.className = 'message system-message';
                messageEl.textContent = message;
                this.chatEl.appendChild(messageEl);
                this.scrollToBottom();
            }
            
            addChatMessage(username, message, timestamp) {
                const messageEl = document.createElement('div');
                const isCurrentUser = username === this.username;
                
                messageEl.className = `message ${isCurrentUser ? 'user-message' : 'other-message'}`;
                
                messageEl.innerHTML = `
                    <div class="message-info">
                        ${username} • ${new Date(timestamp).toLocaleTimeString()}
                    </div>
                    ${message}
                `;
                
                this.chatEl.appendChild(messageEl);
                this.scrollToBottom();
            }
            
            sendMessage() {
                if (!this.isConnected || !this.messageInput.value.trim()) return;
                
                const message = {
                    username: this.username,
                    message: this.messageInput.value.trim()
                };
                
                this.ws.send(JSON.stringify(message));
                this.messageInput.value = '';
            }
            
            scrollToBottom() {
                this.chatEl.scrollTop = this.chatEl.scrollHeight;
            }
        }
        
        // Initialize the chat when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new WebSocketChat();
        });
    </script>
</body>
</html>